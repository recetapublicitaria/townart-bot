const { getSession, clearSession } = require("./sessionStore");
const { twilioSend } = require("../utils/twilio");
const { parseDateNatural, parseHourNatural } = require("../utils/nlp");
const { createCalendarEvent } = require("./calendar");
const knowledge = require("./knowledge");

async function startFlow(from, text, session, initial = false) {

  // Paso 0: inicio
  if (initial || session.step === 0) {
    session.step = 1;
    return twilioSend(from,
      "âœ¨ Â¡Perfecto! Antes de agendar, Â¿cÃ³mo te llamas?"
    );
  }

  // Paso 1: nombre
  if (session.step === 1) {
    session.data.nombre = text;
    session.step = 2;
    return twilioSend(from,
      `Mucho gusto ${text} ğŸ©·\nÂ¿Te gustarÃ­a agendar *SPA* o *CLASE DE POLE*?`
    );
  }

  // Paso 2: tipo
  if (session.step === 2) {
    const t = text.toLowerCase();
    if (t.includes("spa")) session.data.tipo = "SPA";
    else if (t.includes("pole")) session.data.tipo = "POLE";
    else return twilioSend(from, "Solo dime *SPA* o *POLE* ğŸ˜Š");

    session.step = 3;

    if (session.data.tipo === "SPA") {
      return twilioSend(from,
        "Â¿QuÃ© servicio te interesa? (Ej: limpieza facial profunda, antiacnÃ©, despigmentaciÃ³n...)\nğŸ“Œ *Recuerda:* lo mÃ¡s recomendable siempre es una valoraciÃ³n de $200."
      );
    }

    if (session.data.tipo === "POLE") {
      return twilioSend(from,
        "Perfecto ğŸ©° Â¿QuÃ© clase deseas? (Pole Fitness, Flying Pole, Flexi, Floorwork, Acrobacia)"
      );
    }
  }

  // Paso 3: servicio
  if (session.step === 3) {
    session.data.servicio = text;

    session.step = 4;
    return twilioSend(from,
      "Â¿Para quÃ© dÃ­a quieres tu cita? Puedes decir:\nâ†’ *maÃ±ana*\nâ†’ *lunes*\nâ†’ *15 de enero*"
    );
  }

  // Paso 4: fecha
  if (session.step === 4) {
    const fecha = parseDateNatural(text);
    if (!fecha)
      return twilioSend(from, "No entendÃ­ la fecha ğŸ˜¥ prueba con algo como:\n*lunes*, *maÃ±ana*, *15 de enero*");

    session.data.fecha = fecha;
    session.step = 5;

    return twilioSend(from,
      "Â¿A quÃ© hora te gustarÃ­a? Puedes decir:\nâ†’ *a las 5*\nâ†’ *3 pm*\nâ†’ *18:00*"
    );
  }

  // Paso 5: hora
  if (session.step === 5) {
    const hora = parseHourNatural(text);
    if (!hora) return twilioSend(from, "No entendÃ­ la hora, prueba con *5 pm* o *17:00*");

    session.data.hora = hora;
    session.step = 6;

    return twilioSend(from,
      `ConfÃ­rmame por favor:\nğŸ“Œ *${session.data.tipo} â€“ ${session.data.servicio}*\nğŸ—“ï¸ ${session.data.fecha}\nğŸ•’ ${session.data.hora}\n\nÂ¿Lo agendamos?`
    );
  }

  // Paso 6: confirmaciÃ³n
  if (session.step === 6) {
    if (!text.toLowerCase().startsWith("s")) {
      session.step = 4;
      return twilioSend(from,
        "No pasa nada ğŸ˜Š dime otra fecha para ajustarlo."
      );
    }

    await createCalendarEvent(session.data);
    clearSession(from);

    return twilioSend(from,
      "Â¡Listo! âœ¨ Ya quedÃ³ agendado.\nCualquier cambio solo escrÃ­beme aquÃ­ ğŸ©·"
    );
  }
}

module.exports = { startFlow };
